{% extends "base.html" %}
{% load static %}

{% block title %}Каталог IT-решений{% endblock %}

{% block head %}
<style>
  /* Стили для панели поиска / счетчик / кнопки Фильтры */
  .catalog-header {
    background-color: #3c2a62;
    color: #fff;
    padding: 1rem;
    border-radius: .5rem;
  }
  .catalog-header .total-count {
    font-size: 1.25rem;
    font-weight: 500;
  }
  .catalog-header .search-input {
    width: 100%;
    max-width: 400px;
  }
  .catalog-header .btn-filters {
    white-space: nowrap;
  }

  /* Скрытая панель фильтров */
  #filterCollapse {
    background-color: #4f397c;
    padding: 1rem;
    border-radius: .5rem;
    margin-top: .5rem;
  }
  #filterCollapse .form-label,
  #filterCollapse .form-check-label {
    color: #fff;
  }
  #filterCollapse .btn-outline-primary,
  #filterCollapse .btn-outline-light,
  #filterCollapse .form-control {
    background-color: #6b5598;
    border-color: #8a6fc1;
    color: #fff;
  }
  #filterCollapse .btn-outline-primary:hover,
  #filterCollapse .btn-outline-light:hover {
    background-color: #806db6;
    color: #fff;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Заголовок каталога -->
  <h2 class="mb-3 text-white">Каталог IT-решений</h2>

  <!-- Панель поиска / счетчик / кнопка «Фильтры» -->
  <div class="catalog-header d-flex flex-column flex-md-row align-items-center justify-content-between">
    <!-- Слева: общее количество решений -->
    <div class="total-count mb-2 mb-md-0">
      Всего решений: <span id="totalCount">{{ page_content.solutions|length }}</span>
    </div>

    <!-- По центру: поле поиска -->
    <div class="flex-grow-1 mx-md-3 mb-2 mb-md-0 text-center">
      <input
        type="text"
        class="form-control search-input"
        placeholder="Поиск решения…"
        aria-label="Поиск"
      >
    </div>

    <!-- Справа: кнопка открытия панели фильтров -->
    <div>
      <button
        class="btn btn-outline-light btn-filters"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#filterCollapse"
        aria-expanded="false"
        aria-controls="filterCollapse"
      >
        Фильтры
      </button>
    </div>
  </div>

  <!-- Скрытая панель фильтров (Collapse) -->
  <div class="collapse" id="filterCollapse">
    <div class="row g-3" id="filterPanel">
      <!-- Фильтрация по тегам -->
      <div class="col-12 col-md-6">
        <label class="form-label">Теги:</label>
        <div class="btn-group d-flex flex-wrap" role="group" aria-label="Фильтр по тегам">
          {% comment %}
            Для каждого тега из контекста page_content.tags создаём уникальный id через slugify,
            чтобы не было дублирования. Проверяйте, что фильтр slugify установлен в вашем Django.
          {% endcomment %}
          {% for tag in page_content.tags %}
            {% with tag_slug=tag|slugify %}
              <input
                type="checkbox"
                class="btn-check"
                name="tags"
                id="filterTag_{{ tag_slug }}"
                value="{{ tag_slug }}"
                autocomplete="off"
              >
              <label
                class="btn btn-outline-primary me-2 mb-2"
                for="filterTag_{{ tag_slug }}"
              >
                {{ tag }}
              </label>
            {% endwith %}
          {% empty %}
            <span class="text-light">Нет доступных тегов</span>
          {% endfor %}
        </div>
      </div>

      <!-- Фильтрация по готовности (Стартап/Продукт) -->
      <div class="col-12 col-md-6">
        <label class="form-label">Статус:</label>
        <div class="btn-group w-100" role="group" aria-label="Фильтр по статусу">
          <input
            type="radio"
            class="btn-check"
            name="statusOptions"
            id="statusAll"
            value="all"
            autocomplete="off"
            checked
          >
          <label class="btn btn-outline-light me-2 mb-2" for="statusAll">Все</label>

          <input
            type="radio"
            class="btn-check"
            name="statusOptions"
            id="statusStartup"
            value="startup"
            autocomplete="off"
          >
          <label class="btn btn-outline-light me-2 mb-2" for="statusStartup">Стартап</label>

          <input
            type="radio"
            class="btn-check"
            name="statusOptions"
            id="statusProduct"
            value="product"
            autocomplete="off"
          >
          <label class="btn btn-outline-light mb-2" for="statusProduct">Продукт</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Сетка карточек -->
  <div class="row g-4 mt-3">
    {% for sol in page_content.solutions %}
      <div class="col-12 col-md-6 col-lg-4">
        <div
          class="card h-100 shadow-sm"
          data-bs-toggle="modal"
          data-bs-target="#detailModal"
          data-bs-title="{{ sol.title }}"
          data-bs-description="{{ sol.description }}"
          data-bs-org="{{ sol.org }}"
          data-bs-phone="{{ sol.phone }}"
          data-bs-email="{{ sol.email }}"
          data-bs-site="{{ sol.site }}"
          data-bs-imgurl="{% static sol.img %}"
        >
          <img
            src="{% static sol.img %}"
            class="card-img-top"
            alt="{{ sol.title }}"
          >
          <div class="card-body">
            <h5 class="card-title">{{ sol.title|truncatechars:45 }}</h5>
            <p class="card-text">{{ sol.short|truncatechars:80 }}</p>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <p class="text-light">Решения не найдены.</p>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Общее модальное окно -->
<div
  class="modal fade"
  id="detailModal"
  tabindex="-1"
  aria-labelledby="detailModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalLabel"></h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Закрыть"
        ></button>
      </div>
      <div class="modal-body">
        <img
          id="detailModalImage"
          src=""
          alt="Изображение"
          class="img-fluid mb-3"
        >
        <p id="detailModalDescription"></p>
        <hr>
        <h6 class="fw-bold">Организация и контакты</h6>
        <p class="mb-1"><strong>Организация:</strong> <span id="detailModalOrg"></span></p>
        <p class="mb-1"><strong>Телефон:</strong> <span id="detailModalPhone"></span></p>
        <p class="mb-1"><strong>Почта:</strong> <span id="detailModalEmail"></span></p>
        <p><strong>Сайт:</strong> <a id="detailModalSite" href="#" target="_blank"></a></p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Закрыть
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Скрипт для заполнения модального окна -->
<script>
  const detailModal = document.getElementById('detailModal');
  detailModal.addEventListener('show.bs.modal', event => {
    const card = event.relatedTarget;

    detailModal.querySelector('#detailModalLabel').textContent =
      card.getAttribute('data-bs-title');
    detailModal.querySelector('#detailModalImage').src =
      card.getAttribute('data-bs-imgurl');
    detailModal.querySelector('#detailModalDescription').textContent =
      card.getAttribute('data-bs-description');

    detailModal.querySelector('#detailModalOrg').textContent =
      card.getAttribute('data-bs-org');
    detailModal.querySelector('#detailModalPhone').textContent =
      card.getAttribute('data-bs-phone');
    detailModal.querySelector('#detailModalEmail').textContent =
      card.getAttribute('data-bs-email');

    const siteEl = detailModal.querySelector('#detailModalSite');
    siteEl.textContent = card.getAttribute('data-bs-site');
    siteEl.href = card.getAttribute('data-bs-site');
  });
</script>
{% endblock %}
