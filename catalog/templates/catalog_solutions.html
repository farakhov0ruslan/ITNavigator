{% extends "base.html" %}
{% load static %}

{% block title %}Каталог IT-решений{% endblock %}

{% block head %}
	<link rel="stylesheet" href="{% static 'deps/css/catalog-sol.css' %}">
{% endblock %}

{% block content %}
	<div class="container my-4">
		<h2 class="mb-3 text-white">Каталог IT-решений</h2>

		<!-- Навигация -->
		<a href="{% url 'catalog:requests' %}" class="btn btn-light rounded-pill px-4 py-2">
			Запросы на IT-решения
		</a>
		{% if user.is_authenticated %}
			<button
					type="button"
					class="btn btn-light rounded-pill px-4 py-2"
					data-bs-toggle="modal"
					data-bs-target="#solutionModal"
			>
				+ Предложить IT-решение
			</button>
		{% else %}
			<span class="d-inline-block" data-bs-toggle="tooltip"
			      title="Только для зарегистрированных пользователей как Компания. Войдите, чтобы предложить решение">
      <button
		      type="button"
		      class="btn btn-light rounded-pill px-4 py-2"
		      disabled
      >
          + Предложить IT-решение
      </button>
    </span>
		{% endif %}


		<!-- Flash-сообщения -->
		{% if messages %}
			<div class="mt-3">
				{% for message in messages %}
					<div class="alert alert-{{ message.tags }} text-white alert-dismissible fade show"
					     role="alert">
						{{ message }}
						<button type="button" class="btn-close" data-bs-dismiss="alert"
						        aria-label="Закрыть"></button>
					</div>
				{% endfor %}
			</div>
		{% endif %}

		<!-- Форма GET-фильтров -->
		<form method="get" action="">
			<div class="catalog-header">
				<div class="total-count">
					Всего решений: <span id="totalCount">{{ page_content.solutions|length }}</span>
				</div>

				<input
						type="text"
						name="q"
						class="form-control search-input"
						placeholder="Поиск решения…"
						value="{{ page_content.search_query }}"
				>

				<button
						class="btn btn-outline-light btn-filters"
						type="button"
						data-bs-toggle="collapse"
						data-bs-target="#filterCollapse"
						aria-expanded="false"
						aria-controls="filterCollapse"
				>
					Фильтры
				</button>
			</div>

			<div class="collapse" id="filterCollapse">
				<div class="row g-3">
					<div class="col-md-6">
						<label class="form-label text-white">Теги:</label>
						<div class="d-flex flex-wrap">
							{% for tag in page_content.tags %}
								{% with slug=tag.slug %}
									<input
											type="checkbox"
											class="btn-check"
											name="tags"
											id="filterTag_{{ slug }}"
											value="{{ slug }}"
											autocomplete="off"
											{% if slug in page_content.selected_tags %}checked{% endif %}
									>
									<label class="btn btn-outline-primary me-2 mb-2"
									       for="filterTag_{{ slug }}">
										{{ tag.name }}
									</label>
								{% endwith %}
							{% empty %}
								<span class="text-light">Нет доступных тегов</span>
							{% endfor %}
						</div>
					</div>

					<div class="col-md-6">
						<label class="form-label text-white">Статус:</label>
						<div class="status-group">
							<input type="radio" class="btn-check" name="status" id="statusAll"
							       value="all" autocomplete="off"
							       {% if page_content.selected_status == 'all' %}checked{% endif %}>
							<label class="btn btn-outline-light me-2 mb-2"
							       for="statusAll">Все</label>

							<input type="radio" class="btn-check" name="status" id="statusStartup"
							       value="startup" autocomplete="off"
							       {% if page_content.selected_status == 'startup' %}checked{% endif %}>
							<label class="btn btn-outline-light me-2 mb-2" for="statusStartup">Стартап</label>

							<input type="radio" class="btn-check" name="status" id="statusProduct"
							       value="product" autocomplete="off"
							       {% if page_content.selected_status == 'product' %}checked{% endif %}>
							<label class="btn btn-outline-light mb-2"
							       for="statusProduct">Продукт</label>
						</div>
					</div>

					<div class="col-12 text-end">
						<button type="submit" class="btn btn-primary">Применить</button>
					</div>
				</div>
			</div>
		</form>

		<!-- Сетка карточек -->
		<div class="row g-4 mt-3">
			{% for sol in page_content.solutions %}
				<div class="col-12 col-md-6 col-lg-4">
					<div
							class="card custom-card h-100 shadow-sm"
							data-bs-toggle="modal"
							data-bs-target="#detailModal"
							data-bs-title="{{ sol.title }}"
							data-bs-description="{{ sol.description }}"
							data-bs-org="{{ sol.organization }}"
							data-bs-phone="{{ sol.phone }}"
							data-bs-email="{{ sol.email }}"
							data-bs-site="{{ sol.site }}"
							{% if sol.image %}
							data-bs-imgurl="{{ sol.image.url }}"
							{% else %}
							data-bs-imgurl=""
							{% endif %}

					>
						{% if sol.image %}
							<img src="{{ sol.image.url }}" class="card-img-top"
							     alt="{{ sol.title }}">
						{% endif %}
						<div class="card-body">
							<h5 class="card-title">{{ sol.title|truncatechars:45 }}</h5>
							<p class="card-text">{{ sol.short_description|truncatechars:80 }}</p>
						</div>
					</div>
				</div>
			{% empty %}
				<div class="col-12">
					<p class="text-light">Решения не найдены.</p>
				</div>
			{% endfor %}
		</div>
	</div>

	<!-- Модальное окно деталей решения -->
	<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="detailModalLabel"></h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<img id="detailModalImage" class="img-fluid mb-3" alt="Изображение">
					<p id="detailModalDescription"></p>
					<hr>
					<h6 class="fw-bold">Организация и контакты</h6>
					<p class="mb-1"><strong>Организация:</strong> <span id="detailModalOrg"></span>
					</p>
					<p class="mb-1"><strong>Телефон:</strong> <span id="detailModalPhone"></span>
					</p>
					<p class="mb-1"><strong>Почта:</strong> <span id="detailModalEmail"></span></p>
					<p><strong>Сайт:</strong> <a id="detailModalSite" target="_blank"></a></p>
				</div>
			</div>
		</div>
	</div>

	<!-- Модальное окно создания решения -->
	<div class="modal fade" id="solutionModal" tabindex="-1" aria-labelledby="solutionModalLabel"
	     aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content bg-dark text-white border-0">
				<div class="modal-header border-0">
					<h5 class="modal-title" id="solutionModalLabel">Предложить IT-решение</h5>
					<button type="button" class="btn-close btn-close-white"
					        data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form
							id="solutionForm"
							method="post"
							action="{% url 'catalog:solution_create' %}"
							enctype="multipart/form-data"
					>
						{% csrf_token %}
						{{ solution_form.non_field_errors }}

						<div class="mb-3">
							{{ solution_form.title.label_tag }}
							{{ solution_form.title }}
							{% if solution_form.title.errors %}
								<div class="text-danger small">{{ solution_form.title.errors|striptags }}</div>
							{% endif %}
						</div>

						<div class="mb-3">
							{{ solution_form.short_description.label_tag }}
							{{ solution_form.short_description }}
							{% if solution_form.short_description.errors %}
								<div class="text-danger small">{{ solution_form.short_description.errors|striptags }}</div>
							{% endif %}
						</div>

						<div class="mb-3">
							{{ solution_form.category.label_tag }}
							{{ solution_form.category }}
							{% if solution_form.category.errors %}
								<div class="text-danger small">{{ solution_form.category.errors|striptags }}</div>
							{% endif %}
						</div>

						<div class="mb-3">
							{{ solution_form.organization.label_tag }}
							{{ solution_form.organization }}
							{% if solution_form.organization.errors %}
								<div class="text-danger small">{{ solution_form.organization.errors|striptags }}</div>
							{% endif %}
						</div>

						<div class="mb-3">
							{{ solution_form.phone.label_tag }}
							{{ solution_form.phone }}
							{% if solution_form.phone.errors %}
								<div class="text-danger small">{{ solution_form.phone.errors|striptags }}</div>
							{% endif %}
						</div>

						<div class="mb-3">
							{{ solution_form.email.label_tag }}
							{{ solution_form.email }}
							{% if solution_form.email.errors %}
								<div class="text-danger small">{{ solution_form.email.errors|striptags }}</div>
							{% endif %}
						</div>

						<div class="mb-3">
							{{ solution_form.site.label_tag }}
							{{ solution_form.site }}
							{% if solution_form.site.errors %}
								<div class="text-danger small">{{ solution_form.site.errors|striptags }}</div>
							{% endif %}
						</div>

						<div class="mb-3">
							{{ solution_form.image.label_tag }}
							{{ solution_form.image }}
							{% if solution_form.image.errors %}
								<div class="text-danger small">{{ solution_form.image.errors|striptags }}</div>
							{% endif %}
						</div>

					</form>
				</div>
				<div class="modal-footer border-0 justify-content-center">
					<button
							type="submit"
							form="solutionForm"
							class="btn btn-primary btn-lg btn-pill"
					>Отправить
					</button>
				</div>
			</div>
		</div>
	</div>

	<script>
        // заполнение detailModal
        const detailModal = document.getElementById('detailModal');
        detailModal.addEventListener('show.bs.modal', event => {
            const card = event.relatedTarget;
            detailModal.querySelector('#detailModalLabel').textContent = card.getAttribute('data-bs-title');
            detailModal.querySelector('#detailModalImage').src = card.getAttribute('data-bs-imgurl');
            detailModal.querySelector('#detailModalDescription').textContent = card.getAttribute('data-bs-description');
            detailModal.querySelector('#detailModalOrg').textContent = card.getAttribute('data-bs-org');
            detailModal.querySelector('#detailModalPhone').textContent = card.getAttribute('data-bs-phone');
            detailModal.querySelector('#detailModalEmail').textContent = card.getAttribute('data-bs-email');
            const siteEl = detailModal.querySelector('#detailModalSite');
            siteEl.textContent = card.getAttribute('data-bs-site');
            siteEl.href = card.getAttribute('data-bs-site');
        });
	</script>
{% endblock %}
